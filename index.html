<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI ç©¿æ­å»ºè­°å°å¹«æ‰‹ï¼ˆIndexedDB ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui;
  background:#f5f5f7;
  color:#222;
}
header{
  background:linear-gradient(120deg,#fbc2eb,#a6c1ee);
  padding:20px;
}
main{
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  padding:16px;
}
.panel{
  background:white;
  padding:16px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
.left{flex:3 1 600px;}
.right{flex:1 1 280px;}

.upload-section{
  border:2px dashed #ccc;
  padding:12px;
  border-radius:12px;
  margin-bottom:16px;
}
.upload-title{
  font-weight:700;
  font-size:1.05rem;
  margin-bottom:6px;
}

.image-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns:repeat(auto-fill,100px);
  gap:10px;
}
.thumb-box{
  width:100px;
  height:100px;
  position:relative;
}
.thumb{
  width:100%;
  height:100%;
  border-radius:10px;
  object-fit:cover;
  border:1px solid #ddd;
}
.delete-btn{
  position:absolute;
  top:-6px;
  right:-6px;
  background:#ff4d4d;
  width:22px;
  height:22px;
  border-radius:50%;
  border:none;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
button.primary{
  background:#ff7eb3;
  color:white;
}
.history-btn{
  margin-top:12px;
  width:100%;
  background:#4a90e2;
  color:white;
}

.outfit-img{
  width:100%;
  max-width:180px;
  border-radius:10px;
  margin-top:6px;
}
.outfit-item{margin-bottom:12px;}
.outfit-label{font-weight:bold;margin-bottom:4px;}

select{
  padding:6px 10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

#saveBtn{
  display:none;
  width:100%;
  background:#4a90e2;
  color:white;
  margin-top:10px;
}
</style>
</head>

<body>

<header>
  <h1>ä½ çš„è¡£æ«¥ï½œAI ç©¿æ­å»ºè­°å°å¹«æ‰‹</h1>
  <p>ä¸Šå‚³æ™‚ç›´æ¥æŒ‡å®šé•·çŸ­è¢– / é•·çŸ­è¤²</p>
</header>

<main>
<section class="panel left">
  <h2>ä¸Šè¡£</h2>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘• çŸ­è¢–ä¸Šè¡£</div>
    <input type="file" id="uploadTopShort" accept="image/*" multiple>
    <div id="topShortGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘• é•·è¢–ä¸Šè¡£</div>
    <input type="file" id="uploadTopLong" accept="image/*" multiple>
    <div id="topLongGrid" class="image-grid"></div>
  </div>

  <h2>ä¸‹è‘—</h2>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘– çŸ­è¤² / è£™</div>
    <input type="file" id="uploadBottomShort" accept="image/*" multiple>
    <div id="bottomShortGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘– é•·è¤² / é•·è£™</div>
    <input type="file" id="uploadBottomLong" accept="image/*" multiple>
    <div id="bottomLongGrid" class="image-grid"></div>
  </div>

  <h2>å…¶ä»–</h2>

  <div class="upload-section">
    <div class="upload-title">ğŸ§¥ å¤–å¥—</div>
    <input type="file" id="uploadOuter" accept="image/*" multiple>
    <div id="outerGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘Ÿ é‹å­</div>
    <input type="file" id="uploadShoes" accept="image/*" multiple>
    <div id="shoesGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ’ é…ä»¶</div>
    <input type="file" id="uploadAcc" accept="image/*" multiple>
    <div id="accGrid" class="image-grid"></div>
  </div>

  <button class="history-btn" onclick="location.href='history.html'">
    ğŸ“œ æŸ¥çœ‹ç©¿æ­æ­·å²
  </button>
</section>

<aside class="panel right">
  <h2>ä»Šæ—¥ç©¿æ­é¸é …</h2>

  <label>é¢¨æ ¼ï¼š</label>
  <select id="styleSelect">
    <option value="casual">ä¼‘é–’æ–‡é’</option>
    <option value="minimal">æ¥µç°¡</option>
    <option value="dopamine">å¤šå·´èƒº</option>
    <option value="sporty">é‹å‹•</option>
    <option value="formal">æ­£å¼</option>
  </select>

  <label>å¤©æ°£ï¼š</label>
  <select id="weatherSelect">
    <option value="hot">ç‚ç†±</option>
    <option value="cool">æ¶¼çˆ½</option>
    <option value="windy">é¢¨å¤§</option>
    <option value="rainy">ä¸‹é›¨</option>
    <option value="cold">å¯’å†·</option>
  </select>

  <label>å ´åˆï¼š</label>
  <select id="occasionSelect">
    <option value="school">ä¸Šèª²</option>
    <option value="date">ç´„æœƒ</option>
    <option value="casual">ä¼‘é–’å‡ºéŠ</option>
    <option value="formal">æ­£å¼å ´åˆ</option>
    <option value="work">å·¥ä½œ</option>
  </select>

  <button class="primary" id="genBtn">ç”Ÿæˆç©¿æ­</button>

  <h3>ç©¿æ­çµæœ</h3>
  <div id="outfit"></div>
  <button id="saveBtn">â¤ï¸ å„²å­˜é€™å¥—ç©¿æ­</button>
</aside>
</main>

<canvas id="colorCanvas" style="display:none;"></canvas>

<script>
// ===============================
// å…¨åŸŸè³‡æ–™
// ===============================
let tops=[], bottoms=[], outers=[], shoes=[], accs=[];
let currentOutfit=null;

const canvas=document.getElementById("colorCanvas");
const ctx=canvas.getContext("2d");

// ===============================
// IndexedDB
// ===============================
let db;
const DB_NAME="WardrobeDB";
const STORE="clothes";

function initDB(){
  const req=indexedDB.open(DB_NAME,1);
  req.onupgradeneeded=e=>{
    db=e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      db.createObjectStore(STORE,{keyPath:"id"});
    }
  };
  req.onsuccess=e=>{
    db=e.target.result;
    loadFromDB();
  };
}
function saveToDB(item){
  db.transaction([STORE],"readwrite").objectStore(STORE).put(item);
}
function deleteFromDB(id){
  db.transaction([STORE],"readwrite").objectStore(STORE).delete(id);
}
function loadFromDB(){
  const req=db.transaction([STORE],"readonly").objectStore(STORE).getAll();
  req.onsuccess=()=>{
    req.result.forEach(i=>{
      if(i.category==="top") tops.push(i);
      if(i.category==="bottom") bottoms.push(i);
      if(i.category==="outer") outers.push(i);
      if(i.category==="shoes") shoes.push(i);
      if(i.category==="acc") accs.push(i);
    });
    renderAll();
  };
}
initDB();

// ===============================
// ä¸Šå‚³
// ===============================
uploadTopShort.onchange=e=>addImages(e,tops,"topShortGrid","short-sleeve");
uploadTopLong.onchange=e=>addImages(e,tops,"topLongGrid","long-sleeve");
uploadBottomShort.onchange=e=>addImages(e,bottoms,"bottomShortGrid","shorts");
uploadBottomLong.onchange=e=>addImages(e,bottoms,"bottomLongGrid","long-pants");
uploadOuter.onchange=e=>addImages(e,outers,"outerGrid","outer");
uploadShoes.onchange=e=>addImages(e,shoes,"shoesGrid","shoes");
uploadAcc.onchange=e=>addImages(e,accs,"accGrid","acc");

function addImages(e,list,gridId,fixedType){
  [...e.target.files].forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>{
      const item={
        id:"cloth_"+Date.now()+Math.random(),
        category:list===tops?"top":list===bottoms?"bottom":list===outers?"outer":list===shoes?"shoes":"acc",
        clothingType:fixedType,
        url:reader.result
      };
      list.push(item);
      saveToDB(item);
      renderGrid(list,gridId);
    };
    reader.readAsDataURL(file);
  });
}

// ===============================
// æ¸²æŸ“
// ===============================
function renderAll(){
  renderGrid(tops,"topShortGrid");
  renderGrid(tops,"topLongGrid");
  renderGrid(bottoms,"bottomShortGrid");
  renderGrid(bottoms,"bottomLongGrid");
  renderGrid(outers,"outerGrid");
  renderGrid(shoes,"shoesGrid");
  renderGrid(accs,"accGrid");
}

function renderGrid(list,gridId){
  const grid=document.getElementById(gridId);
  grid.innerHTML="";
  list.filter(i=>{
    if(gridId.includes("Short")) return i.clothingType.includes("short");
    if(gridId.includes("Long")) return i.clothingType.includes("long");
    return true;
  }).forEach(i=>{
    const d=document.createElement("div");
    d.className="thumb-box";
    d.innerHTML=`<img src="${i.url}" class="thumb">
                 <button class="delete-btn">Ã—</button>`;
    d.querySelector("button").onclick=()=>{
      const idx=list.findIndex(x=>x.id===i.id);
      list.splice(idx,1);
      deleteFromDB(i.id);
      renderGrid(list,gridId);
    };
    grid.appendChild(d);
  });
}

// ===============================
// ç©¿æ­ç”Ÿæˆï¼ˆå”¯ä¸€é‚è¼¯ä¿®æ”¹ï¼šä¸‹è‘—ï¼‰
// ===============================
genBtn.onclick=()=>{
  outfit.innerHTML="";
  saveBtn.style.display="none";

  const weather=weatherSelect.value;
  const pick=a=>a[Math.floor(Math.random()*a.length)];

  const top=tops.filter(t=>
    weather==="hot" ? t.clothingType==="short-sleeve" : true
  );

  const bottom=bottoms.filter(b=>
    weather==="hot"   ? b.clothingType==="shorts" :
    weather==="windy" ? b.clothingType==="long-pants" :
    weather==="cold"  ? b.clothingType==="long-pants" :
    true
  );

  const t=top.length?pick(top):pick(tops);
  const b=bottom.length?pick(bottom):pick(bottoms);
  const s=shoes.length?pick(shoes):null;
  const a=accs.length && Math.random()<0.5?pick(accs):null;

  show("ğŸ‘• ä¸Šè¡£",t);
  show("ğŸ‘– ä¸‹è‘—",b);
  show("ğŸ‘Ÿ é‹å­",s);
  show("ğŸ’ é…ä»¶",a);

  currentOutfit={t,b,s,a,weather,date:new Date().toLocaleString("zh-Hant")};
  saveBtn.style.display="block";
};

function show(label,i){
  if(!i)return;
  outfit.innerHTML+=`<div class="outfit-item">
    <div class="outfit-label">${label}</div>
    <img src="${i.url}" class="outfit-img">
  </div>`;
}

saveBtn.onclick=()=>{
  const h=JSON.parse(localStorage.getItem("outfitHistory")||"[]");
  h.push(currentOutfit);
  localStorage.setItem("outfitHistory",JSON.stringify(h));
  alert("å·²å„²å­˜");
};
</script>

</body>
</html>

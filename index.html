  <!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI ç©¿æ­å»ºè­°å°å¹«æ‰‹ï¼ˆIndexedDB ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:#f5f5f7;color:#222;}
header{background:linear-gradient(120deg,#fbc2eb,#a6c1ee);padding:20px;}
main{display:flex;flex-wrap:wrap;gap:16px;padding:16px;}
.panel{background:white;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.left{flex:3 1 600px;}
.right{flex:1 1 280px;}

.upload-section{border:2px dashed #ccc;padding:12px;border-radius:12px;margin-bottom:16px;}
.upload-title{font-weight:700;font-size:1.1rem;margin-bottom:6px;}

.image-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns:repeat(auto-fill,100px);
  gap:10px;
}
.thumb-box{width:100px;height:100px;position:relative;}
.thumb{width:100%;height:100%;border-radius:10px;object-fit:cover;border:1px solid #ddd;}
.delete-btn{
  position:absolute;top:-6px;right:-6px;
  background:#ff4d4d;width:22px;height:22px;border-radius:50%;
  border:none;color:white;font-weight:bold;cursor:pointer;
}
.thumb-badge{
  position:absolute;left:4px;bottom:4px;
  background:rgba(0,0,0,0.6);color:#fff;font-size:10px;
  padding:2px 4px;border-radius:6px;
}

button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
button.primary{background:#ff7eb3;color:white;}
.history-btn{margin-top:12px;width:100%;background:#4a90e2;color:white;}

.outfit-img{width:100%;max-width:180px;border-radius:10px;margin-top:6px;}
.outfit-item{margin-bottom:12px;}
.outfit-label{font-weight:bold;margin-bottom:4px;}
.outfit-meta{font-size:12px;color:#555;margin-top:4px;}

select{padding:6px 10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}

#saveBtn{display:none;margin-top:10px;background:#4a90e2;color:white;}
</style>
</head>

<body>

<header>
  <h1>ä½ çš„è¡£æ«¥ï½œAI ç©¿æ­å»ºè­°å°å¹«æ‰‹</h1>
  <p>é¡¯ç¤ºç©©å®šç‰ˆï¼ˆä¿ç•™å…¨éƒ¨åŠŸèƒ½ï¼‹æ”¹å–„æ±ºç­–æµç¨‹ï¼‰</p>
</header>

<main>
<section class="panel left">
  <h2>ä½ çš„è¡£æ«¥</h2>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘• ä¸Šè¡£</div>
    <input type="file" id="uploadTop" accept="image/*" multiple>
    <div id="topGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘– ä¸‹è‘—</div>
    <input type="file" id="uploadBottom" accept="image/*" multiple>
    <div id="bottomGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ§¥ å¤–å¥—</div>
    <input type="file" id="uploadOuter" accept="image/*" multiple>
    <div id="outerGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ‘Ÿ é‹å­</div>
    <input type="file" id="uploadShoes" accept="image/*" multiple>
    <div id="shoesGrid" class="image-grid"></div>
  </div>

  <div class="upload-section">
    <div class="upload-title">ğŸ’ é…ä»¶</div>
    <input type="file" id="uploadAcc" accept="image/*" multiple>
    <div id="accGrid" class="image-grid"></div>
  </div>

  <button class="history-btn" onclick="location.href='history.html'">ğŸ“œ æŸ¥çœ‹ç©¿æ­æ­·å²</button>
</section>

<aside class="panel right">
  <h2>ä»Šæ—¥ç©¿æ­é¸é …</h2>

  <label>é¢¨æ ¼ï¼š</label>
  <select id="styleSelect">
    <option value="casual">ä¼‘é–’æ–‡é’</option>
    <option value="minimal">æ¥µç°¡</option>
    <option value="dopamine">å¤šå·´èƒº</option>
    <option value="sporty">é‹å‹•</option>
    <option value="formal">æ­£å¼</option>
  </select>

  <label>å¤©æ°£ï¼š</label>
  <select id="weatherSelect">
    <option value="hot">ç‚ç†±</option>
    <option value="cool">æ¶¼çˆ½</option>
    <option value="windy">é¢¨å¤§</option>
    <option value="rainy">ä¸‹é›¨</option>
    <option value="cold">å¯’å†·</option>
  </select>

  <label>å ´åˆï¼š</label>
  <select id="occasionSelect">
    <option value="school">ä¸Šèª²</option>
    <option value="date">ç´„æœƒ</option>
    <option value="casual">ä¼‘é–’å‡ºéŠ</option>
    <option value="formal">æ­£å¼å ´åˆ</option>
    <option value="work">å·¥ä½œ</option>
  </select>

  <button class="primary" id="genBtn">ç”Ÿæˆç©¿æ­</button>

  <h3>ç©¿æ­çµæœ</h3>
  <div id="outfit"></div>
  <button id="saveBtn">â¤ï¸ å„²å­˜é€™å¥—ç©¿æ­</button>
</aside>
</main>

<canvas id="colorCanvas" style="display:none;"></canvas>

<script>
// ================= å…¨åŸŸ =================
let tops=[],bottoms=[],outers=[],shoes=[],accs=[];
let currentOutfit=null;
const usedRecently=new Set();

const canvas=document.getElementById("colorCanvas");
const ctx=canvas.getContext("2d");

// ================= IndexedDB =================
let db;
const DB_NAME="WardrobeDB",STORE="clothes";

function initDB(){
  const req=indexedDB.open(DB_NAME,1);
  req.onupgradeneeded=e=>{
    db=e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      db.createObjectStore(STORE,{keyPath:"id"});
    }
  };
  req.onsuccess=e=>{db=e.target.result;loadDB();}
}
function saveDB(item){
  db.transaction([STORE],"readwrite").objectStore(STORE).put(item);
}
function delDB(id){
  db.transaction([STORE],"readwrite").objectStore(STORE).delete(id);
}
function loadDB(){
  const r=db.transaction([STORE],"readonly").objectStore(STORE).getAll();
  r.onsuccess=()=>{
    r.result.forEach(i=>{
      ({top:tops,bottom:bottoms,outer:outers,shoes:shoes,acc:accs})[i.category]?.push(i);
    });
    renderAll();
  };
}
initDB();

// ================= ä¸Šå‚³ï¼ˆé€™è£¡æ˜¯é—œéµä¿®å¾©é»ï¼‰ =================
uploadTop.onchange=e=>addImages(e,tops,"topGrid");
uploadBottom.onchange=e=>addImages(e,bottoms,"bottomGrid");
uploadOuter.onchange=e=>addImages(e,outers,"outerGrid");
uploadShoes.onchange=e=>addImages(e,shoes,"shoesGrid");
uploadAcc.onchange=e=>addImages(e,accs,"accGrid");

function addImages(e,list,gridId){
  [...e.target.files].forEach(file=>{
    const reader=new FileReader();
    reader.onload=async()=>{
      const url=reader.result;

      const color=await analyzeColor(url);
      const category=list===tops?"top":list===bottoms?"bottom":list===outers?"outer":list===shoes?"shoes":"acc";
      const type=await inferClothingType(url,category);

      const item={
        id:"cloth_"+Date.now()+Math.random(),
        category,
        url,
        colorName:color.colorName,
        family:color.family,
        styleTag:color.styleTag,
        clothingType:type
      };

      list.push(item);
      saveDB(item);
      renderGrid(list,gridId); // âœ… ç«‹å³é¡¯ç¤º
    };
    reader.readAsDataURL(file);
  });
}

// ================= æ¸²æŸ“ =================
function renderAll(){
  renderGrid(tops,"topGrid");
  renderGrid(bottoms,"bottomGrid");
  renderGrid(outers,"outerGrid");
  renderGrid(shoes,"shoesGrid");
  renderGrid(accs,"accGrid");
}
function renderGrid(list,id){
  const g=document.getElementById(id);
  g.innerHTML="";
  list.forEach((i,idx)=>{
    const d=document.createElement("div");
    d.className="thumb-box";
    d.innerHTML=`<img src="${i.url}" class="thumb"><button class="delete-btn">Ã—</button>`;
    d.querySelector("button").onclick=()=>{
      list.splice(idx,1);
      usedRecently.delete(i.id);
      delDB(i.id);
      renderGrid(list,id);
    };
    g.appendChild(d);
  });
}

// ================= åˆ†æ =================
function analyzeColor(url){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      canvas.width=40;canvas.height=40;
      ctx.drawImage(img,0,0,40,40);
      const d=ctx.getImageData(0,0,40,40).data;
      let r=0,g=0,b=0,c=0;
      for(let i=0;i<d.length;i+=4){
        if(d[i+3]<128)continue;
        r+=d[i];g+=d[i+1];b+=d[i+2];c++;
      }
      if(!c) return res({colorName:"gray",family:"neutral",styleTag:"minimal"});
      const avg=(r+g+b)/(3*c);
      res(avg>200?{colorName:"light",family:"neutral",styleTag:"minimal"}:{colorName:"dark",family:"neutral",styleTag:"formal"});
    };
    img.src=url;
  });
}
function inferClothingType(url,cat){
  return new Promise(res=>{
    if(cat!=="top"&&cat!=="bottom") return res("unknown");
    const img=new Image();
    img.onload=()=>{
      const r=img.height/img.width;
      if(cat==="top") res(r>1.3?"long-sleeve":"short-sleeve");
      else res(r>1.4?"long-pants":"shorts");
    };
    img.src=url;
  });
}

// ================= æ¨è–¦ =================
function score(item,weather){
  let s=Math.random();
  if(weather==="hot"&&item.clothingType.includes("long")) s-=2;
  if(weather==="cold"&&item.clothingType.includes("short")) s-=1;
  if(usedRecently.has(item.id)) s-=1;
  return s;
}
function pick(list,weather){
  if(!list.length) return null;
  return [...list].map(i=>({i,sc:score(i,weather)})).sort((a,b)=>b.sc-a.sc)[0].i;
}

genBtn.onclick=()=>{
  outfit.innerHTML="";
  saveBtn.style.display="none";
  const weather=weatherSelect.value;

  const top=pick(tops,weather);
  const bottom=pick(bottoms,weather);
  const shoesPick=pick(shoes,weather);
  const accPick=Math.random()<0.5?pick(accs,weather):null;

  [top,bottom,shoesPick,accPick].forEach(i=>i&&usedRecently.add(i.id));

  function show(label,item){
    if(!item)return;
    outfit.innerHTML+=`<div class="outfit-item"><div class="outfit-label">${label}</div><img src="${item.url}" class="outfit-img"></div>`;
  }

  show("ğŸ‘• ä¸Šè¡£",top);
  show("ğŸ‘– ä¸‹è‘—",bottom);
  show("ğŸ‘Ÿ é‹å­",shoesPick);
  show("ğŸ’ é…ä»¶",accPick);

  currentOutfit={top,bottom,shoes:shoesPick,acc:accPick,weather,date:new Date().toLocaleString("zh-Hant")};
  saveBtn.style.display="block";
};

saveBtn.onclick=()=>{
  const h=JSON.parse(localStorage.getItem("outfitHistory")||"[]");
  h.push(currentOutfit);
  localStorage.setItem("outfitHistory",JSON.stringify(h));
  alert("å·²å„²å­˜");
};
</script>
</body>
</html>

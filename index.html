<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI 穿搭建議小幫手（IndexedDB 版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:#f5f5f7;color:#222;}
header{background:linear-gradient(120deg,#fbc2eb,#a6c1ee);padding:20px;}
main{display:flex;flex-wrap:wrap;gap:16px;padding:16px;}
.panel{background:white;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.left{flex:3 1 600px;}
.right{flex:1 1 280px;}

.upload-section{border:2px dashed #ccc;padding:12px;border-radius:12px;margin-bottom:16px;}
.upload-title{font-weight:700;margin-bottom:6px;}

.image-grid{display:grid;grid-template-columns:repeat(auto-fill,100px);gap:10px;}
.thumb-box{width:100px;height:100px;position:relative;}
.thumb{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.delete-btn{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:50%;border:none;background:#ff4d4d;color:#fff;font-weight:bold;cursor:pointer;}

button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.primary{background:#ff7eb3;color:#fff;}
.history-btn{width:100%;background:#4a90e2;color:#fff;margin-top:12px;}

.outfit-img{width:100%;max-width:180px;border-radius:10px;margin-top:6px;}
.outfit-item{margin-bottom:12px;}
.outfit-label{font-weight:bold;margin-bottom:4px;}

select{width:100%;padding:6px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}
#saveBtn{display:none;width:100%;background:#4a90e2;color:#fff;margin-top:10px;}
</style>
</head>

<body>

<header>
  <h1>你的衣櫥｜AI 穿搭建議小幫手</h1>
</header>

<main>
<section class="panel left">

<h2>上衣</h2>
<div class="upload-section">
  <div class="upload-title">短袖</div>
  <input type="file" id="uploadTopShort" multiple>
  <div id="topShortGrid" class="image-grid"></div>
</div>
<div class="upload-section">
  <div class="upload-title">長袖</div>
  <input type="file" id="uploadTopLong" multiple>
  <div id="topLongGrid" class="image-grid"></div>
</div>

<h2>下著</h2>
<div class="upload-section">
  <div class="upload-title">短褲 / 裙</div>
  <input type="file" id="uploadBottomShort" multiple>
  <div id="bottomShortGrid" class="image-grid"></div>
</div>
<div class="upload-section">
  <div class="upload-title">長褲 / 長裙</div>
  <input type="file" id="uploadBottomLong" multiple>
  <div id="bottomLongGrid" class="image-grid"></div>
</div>

<h2>其他</h2>
<div class="upload-section">
  <div class="upload-title">外套</div>
  <input type="file" id="uploadOuter" multiple>
  <div id="outerGrid" class="image-grid"></div>
</div>
<div class="upload-section">
  <div class="upload-title">鞋子</div>
  <input type="file" id="uploadShoes" multiple>
  <div id="shoesGrid" class="image-grid"></div>
</div>
<div class="upload-section">
  <div class="upload-title">配件</div>
  <input type="file" id="uploadAcc" multiple>
  <div id="accGrid" class="image-grid"></div>
</div>

<button class="history-btn" onclick="location.href='history.html'">查看穿搭歷史</button>

</section>

<aside class="panel right">

<label>風格</label>
<select id="styleSelect">
  <option value="casual">休閒文青</option>
  <option value="minimal">極簡</option>
  <option value="dopamine">多巴胺</option>
  <option value="sporty">運動</option>
  <option value="formal">正式</option>
</select>

<label>天氣</label>
<select id="weatherSelect">
  <option value="hot">炎熱</option>
  <option value="cool">涼爽</option>
  <option value="windy">風大</option>
  <option value="rainy">下雨</option>
  <option value="cold">寒冷</option>
</select>

<label>場合</label>
<select id="occasionSelect">
  <option value="school">上課</option>
  <option value="date">約會</option>
  <option value="casual">休閒出遊</option>
  <option value="formal">正式場合</option>
  <option value="work">工作</option>
</select>

<button class="primary" id="genBtn">生成穿搭</button>

<h3>穿搭結果</h3>
<div id="outfit"></div>
<button id="saveBtn">儲存這套穿搭</button>

</aside>
</main>

<script>
let tops=[], bottoms=[], outers=[], shoes=[], accs=[];
let currentOutfit=null;

// ===== IndexedDB =====
let db;
const DB_NAME="WardrobeDB";
const STORE="clothes";

function initDB(){
  const req=indexedDB.open(DB_NAME,1);
  req.onupgradeneeded=e=>{
    db=e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      db.createObjectStore(STORE,{keyPath:"id"});
    }
  };
  req.onsuccess=e=>{
    db=e.target.result;
    loadFromDB();
  };
}
function saveToDB(item){
  db.transaction([STORE],"readwrite").objectStore(STORE).put(item);
}
function deleteFromDB(id){
  db.transaction([STORE],"readwrite").objectStore(STORE).delete(id);
}
function loadFromDB(){
  const req=db.transaction([STORE],"readonly").objectStore(STORE).getAll();
  req.onsuccess=()=>{
    req.result.forEach(i=>{
      if(i.category==="top") tops.push(i);
      if(i.category==="bottom") bottoms.push(i);
      if(i.category==="outer") outers.push(i);
      if(i.category==="shoes") shoes.push(i);
      if(i.category==="acc") accs.push(i);
    });
    renderAll();
  };
}
initDB();

// ===== 上傳 =====
uploadTopShort.onchange=e=>addImages(e,tops,"topShortGrid","short-sleeve");
uploadTopLong.onchange=e=>addImages(e,tops,"topLongGrid","long-sleeve");
uploadBottomShort.onchange=e=>addImages(e,bottoms,"bottomShortGrid","shorts");
uploadBottomLong.onchange=e=>addImages(e,bottoms,"bottomLongGrid","long-pants");
uploadOuter.onchange=e=>addImages(e,outers,"outerGrid","outer");
uploadShoes.onchange=e=>addImages(e,shoes,"shoesGrid","shoes");
uploadAcc.onchange=e=>addImages(e,accs,"accGrid","acc");

function addImages(e,list,gridId,type){
  [...e.target.files].forEach(file=>{
    const r=new FileReader();
    r.onload=()=>{
      const item={
        id:"c_"+Date.now()+Math.random(),
        category:list===tops?"top":list===bottoms?"bottom":list===outers?"outer":list===shoes?"shoes":"acc",
        clothingType:type,
        url:r.result
      };
      list.push(item);
      saveToDB(item);
      renderGrid(list,gridId);
    };
    r.readAsDataURL(file);
  });
}

// ===== 渲染 =====
function renderAll(){
  renderGrid(tops,"topShortGrid");
  renderGrid(tops,"topLongGrid");
  renderGrid(bottoms,"bottomShortGrid");
  renderGrid(bottoms,"bottomLongGrid");
  renderGrid(outers,"outerGrid");
  renderGrid(shoes,"shoesGrid");
  renderGrid(accs,"accGrid");
}
function renderGrid(list,gridId){
  const g=document.getElementById(gridId);
  g.innerHTML="";
  list.filter(i=>{
    if(gridId.includes("Short")) return i.clothingType.includes("short");
    if(gridId.includes("Long")) return i.clothingType.includes("long");
    return true;
  }).forEach(i=>{
    const d=document.createElement("div");
    d.className="thumb-box";
    d.innerHTML=`<img src="${i.url}" class="thumb"><button class="delete-btn">×</button>`;
    d.querySelector("button").onclick=()=>{
      const idx=list.findIndex(x=>x.id===i.id);
      list.splice(idx,1);
      deleteFromDB(i.id);
      renderGrid(list,gridId);
    };
    g.appendChild(d);
  });
}

// ===== 穿搭生成規則 =====
genBtn.onclick=()=>{
  outfit.innerHTML="";
  saveBtn.style.display="none";

  const weather=weatherSelect.value;
  const pick=a=>a[Math.floor(Math.random()*a.length)];

  // 上衣
  const topCandidates =
    weather==="hot"  ? tops.filter(t=>t.clothingType==="short-sleeve") :
    weather==="cold" ? tops.filter(t=>t.clothingType==="long-sleeve") :
    tops;

  // 下著
  const bottomCandidates =
    weather==="hot"   ? bottoms.filter(b=>b.clothingType==="shorts") :
    weather==="windy" ? bottoms.filter(b=>b.clothingType==="long-pants") :
    weather==="cold"  ? bottoms.filter(b=>b.clothingType==="long-pants") :
    bottoms;

  // 外套
  const needOuter = weather==="cold";
  const outer = needOuter && outers.length ? pick(outers) : null;

  const t=pick(topCandidates.length?topCandidates:tops);
  const b=pick(bottomCandidates.length?bottomCandidates:bottoms);
  const s=shoes.length?pick(shoes):null;
  const a=accs.length && Math.random()<0.5?pick(accs):null;

  show("上衣",t);
  show("下著",b);
  show("外套",outer);
  show("鞋子",s);
  show("配件",a);

  currentOutfit={t,b,outer,s,a,weather,date:new Date().toLocaleString("zh-Hant")};
  saveBtn.style.display="block";
};

function show(label,i){
  if(!i)return;
  outfit.innerHTML+=`<div class="outfit-item"><div class="outfit-label">${label}</div><img src="${i.url}" class="outfit-img"></div>`;
}

saveBtn.onclick=()=>{
  const h=JSON.parse(localStorage.getItem("outfitHistory")||"[]");
  h.push(currentOutfit);
  localStorage.setItem("outfitHistory",JSON.stringify(h));
  alert("已儲存");
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>AI ç©¿æ­å»ºè­°å°å¹«æ‰‹ï¼ˆIndexedDB ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:#f5f5f7;color:#222;}
header{background:linear-gradient(120deg,#fbc2eb,#a6c1ee);padding:20px;}
main{display:flex;flex-wrap:wrap;gap:16px;padding:16px;}
.panel{background:white;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.left{flex:3 1 600px;}
.right{flex:1 1 280px;}
.upload-section{border:2px dashed #ccc;padding:12px;border-radius:12px;margin-bottom:16px;}
.upload-title{font-weight:700;font-size:1.1rem;margin-bottom:6px;}
.image-grid{margin-top:10px;display:grid;grid-template-columns:repeat(auto-fill,100px);gap:10px;}
.thumb-box{width:100px;height:100px;position:relative;}
.thumb{width:100%;height:100%;border-radius:10px;object-fit:cover;border:1px solid #ddd;}
.delete-btn{position:absolute;top:-6px;right:-6px;background:#ff4d4d;width:22px;height:22px;border-radius:50%;border:none;color:white;font-weight:bold;cursor:pointer;}
.thumb-badge{position:absolute;left:4px;bottom:4px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;padding:2px 4px;border-radius:6px;}
button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
button.primary{background:#ff7eb3;color:white;}
.history-btn{margin-top:12px;width:100%;background:#4a90e2;color:white;}
.outfit-img{width:100%;max-width:180px;border-radius:10px;margin-top:6px;}
.outfit-item{margin-bottom:12px;}
.outfit-label{font-weight:bold;margin-bottom:4px;}
.outfit-meta{font-size:12px;color:#555;margin-top:4px;}
select{padding:6px 10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}
</style>
</head>

<body>
<header>
  <h1>ä½ çš„è¡£æ«¥ï½œAI ç©¿æ­å»ºè­°å°å¹«æ‰‹</h1>
  <p>å»¶å¾Œæ±ºç­– Ã— è»Ÿè©•åˆ†æ¨è–¦ï¼ˆæœŸæœ«å°ˆé¡Œç‰ˆï¼‰</p>
</header>

<main>
<section class="panel left">
  <h2>ä½ çš„è¡£æ«¥</h2>
  <div class="upload-section"><div class="upload-title">ğŸ‘• ä¸Šè¡£</div><input type="file" id="uploadTop" multiple><div id="topGrid" class="image-grid"></div></div>
  <div class="upload-section"><div class="upload-title">ğŸ‘– ä¸‹è‘—</div><input type="file" id="uploadBottom" multiple><div id="bottomGrid" class="image-grid"></div></div>
  <div class="upload-section"><div class="upload-title">ğŸ§¥ å¤–å¥—</div><input type="file" id="uploadOuter" multiple><div id="outerGrid" class="image-grid"></div></div>
  <div class="upload-section"><div class="upload-title">ğŸ‘Ÿ é‹å­</div><input type="file" id="uploadShoes" multiple><div id="shoesGrid" class="image-grid"></div></div>
  <div class="upload-section"><div class="upload-title">ğŸ’ é…ä»¶</div><input type="file" id="uploadAcc" multiple><div id="accGrid" class="image-grid"></div></div>
  <button class="history-btn" onclick="location.href='history.html'">ğŸ“œ æŸ¥çœ‹ç©¿æ­æ­·å²</button>
</section>

<aside class="panel right">
  <h2>ä»Šæ—¥ç©¿æ­</h2>
  <select id="styleSelect"><option value="casual">ä¼‘é–’</option><option value="minimal">æ¥µç°¡</option><option value="dopamine">å¤šå·´èƒº</option><option value="sporty">é‹å‹•</option><option value="formal">æ­£å¼</option></select>
  <select id="weatherSelect"><option value="hot">ç‚ç†±</option><option value="cool">æ¶¼çˆ½</option><option value="windy">é¢¨å¤§</option><option value="rainy">ä¸‹é›¨</option><option value="cold">å¯’å†·</option></select>
  <button class="primary" id="genBtn">ç”Ÿæˆç©¿æ­</button>
  <div id="outfit"></div>
</aside>
</main>

<canvas id="colorCanvas" style="display:none;"></canvas>

<script>
// =================== å…¨åŸŸ ===================
let tops=[],bottoms=[],outers=[],shoes=[],accs=[];
const DB_NAME="WardrobeDB",STORE="clothes";
let db;
const canvas=document.getElementById("colorCanvas"),ctx=canvas.getContext("2d");

// =================== IndexedDB ===================
indexedDB.open(DB_NAME,1).onsuccess=e=>{db=e.target.result;loadDB();}
function save(item){db.transaction([STORE],"readwrite").objectStore(STORE).put(item);}
function del(id){db.transaction([STORE],"readwrite").objectStore(STORE).delete(id);}
function loadDB(){
  const req=db.transaction([STORE],"readonly").objectStore(STORE).getAll();
  req.onsuccess=()=>{req.result.forEach(i=>addToList(i,false));renderAll();}
}

// =================== ä¸Šå‚³ ===================
["Top","Bottom","Outer","Shoes","Acc"].forEach(cat=>{
  document.getElementById("upload"+cat).onchange=e=>handleUpload(e,cat.toLowerCase());
});

function handleUpload(e,category){
  [...e.target.files].forEach(f=>{
    const r=new FileReader();
    r.onload=async()=>{
      const features=await extractFeatures(r.result);
      const item={id:"c_"+Date.now()+Math.random(),category,url:r.result,features};
      addToList(item,true);
    };
    r.readAsDataURL(f);
  });
}

function extractFeatures(url){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>res({ratio:img.height/img.width});
    img.src=url;
  });
}

// =================== åˆ†é¡ ===================
function addToList(item,saveDB){
  ({top:tops,bottom:bottoms,outer:outers,shoes:shoes,acc:accs})[item.category]?.push(item);
  if(saveDB) save(item);
}

function renderAll(){
  [["topGrid",tops],["bottomGrid",bottoms],["outerGrid",outers],["shoesGrid",shoes],["accGrid",accs]]
  .forEach(([id,list])=>render(id,list));
}

function render(id,list){
  const g=document.getElementById(id);g.innerHTML="";
  list.forEach((i,idx)=>{
    const d=document.createElement("div");d.className="thumb-box";
    d.innerHTML=`<img src="${i.url}" class="thumb"><button class="delete-btn">Ã—</button>`;
    d.querySelector("button").onclick=()=>{del(i.id);list.splice(idx,1);renderAll();};
    g.appendChild(d);
  });
}

// =================== æ¨è–¦æ ¸å¿ƒ ===================
function score(item,style,weather){
  let s=Math.random();
  const r=item.features?.ratio||1;
  if(weather==="hot") s+=r<1.3?2:-1;
  if(weather==="cold") s+=r>1.3?2:-1;
  if(item._used) s-=1;
  return s;
}

function pick(list,style,weather){
  if(!list.length) return null;
  const sorted=[...list].map(i=>({i,sc:score(i,style,weather)}))
    .sort((a,b)=>b.sc-a.sc);
  sorted[0].i._used=true;
  return sorted[0].i;
}

document.getElementById("genBtn").onclick=()=>{
  const style=styleSelect.value,weather=weatherSelect.value;
  const o=document.getElementById("outfit");o.innerHTML="";
  const t=pick(tops,style,weather),b=pick(bottoms,style,weather);
  [t,b].forEach((i,idx)=>{
    if(i)o.innerHTML+=`<div class="outfit-item"><b>${idx? "ğŸ‘– ä¸‹è‘—":"ğŸ‘• ä¸Šè¡£"}</b><img src="${i.url}" class="outfit-img"></div>`;
  });
};
</script>
</body>
</html>








